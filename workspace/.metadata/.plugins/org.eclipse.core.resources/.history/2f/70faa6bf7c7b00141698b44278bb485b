package me.p2p.bootstrap;

import java.io.IOException;
import java.net.ServerSocket;
import java.net.Socket;

import me.p2p.EMsgType;
import me.p2p.Log;
import me.p2p.MessageHandler;
import me.p2p.MessageParser;
import me.p2p.constant.PeerPort;
import me.p2p.spec.IBootstrap;
import me.p2p.spec.MessageCallback;

import org.json.JSONObject;

public class BootstrapNode extends Thread implements MessageCallback, IBootstrap {
	final String TAG = "BootstrapNode";
	ServerSocket serverSocket;
	MessageParser msgParser;

	// create bootstrap node with default port
	public BootstrapNode() {
		try {
			serverSocket = new ServerSocket(PeerPort.PORT_BOOTSTRAP);
		} catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
	}

	// run it
	public void run() {
		// TODO Auto-generated method stub
		while (!Thread.interrupted()) {
			try {
				Socket socket = serverSocket.accept();
				MessageHandler msgHandler = new MessageHandler(socket, this);
				msgHandler.handleMessage();
			} catch (IOException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}
	}

	public void listen() {
		System.out.println("Bootstrap Listening...");
		start();
	}

	public void onMessage(Socket peerSocket, JSONObject data) {
		// TODO Auto-generated method stub
		System.out.println("onMessage(): " + data.toString());
		msgParser = new MessageParser(data);
		EMsgType msgType = msgParser.getMessageType();
		JSONObject msgData = msgParser.getMessageData();
		switch (msgType) {
		case JOIN: {
			handleJoinMsg(msgData, peerSocket);
		}
			break;

		case LEAVE: {
			handleLeaveMsg();
		}
			break;
		case UPDATE: {
			handleUpdateMsg();
		}
			break;
		}
	}

	@Override
	public void onSessionStart() {
		// TODO Auto-generated method stub

	}

	@Override
	public void onSessionEnd() {
		// TODO Auto-generated method stub

	}

	@Override
	public void handleJoinMsg(JSONObject data, Socket peerSocket) {
		// TODO Auto-generated method stub
		Log.logToConsole(TAG, "handleJoinMsg()");
		
	}

	@Override
	public void handleLeaveMsg() {
		// TODO Auto-generated method stub
		Log.logToConsole(TAG, "handleLeaveMsg()");
	}

	@Override
	public void handleUpdateMsg() {
		// TODO Auto-generated method stub
		Log.logToConsole(TAG, "handleUpdateMsg()");
	}
}
